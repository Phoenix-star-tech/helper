{% extends 'base.html' %}
{% block title %}Search - Mr. Helper{% endblock %}
{% block content %}

<div class="container mx-auto px-4 py-6">
  <!-- Enhanced Search Header -->
  <div class="text-center mb-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">Find Your Perfect Helper</h1>
    <p class="text-gray-600">Search for services, locations, or specific helpers</p>
  </div>

  <!-- Enhanced Search Container -->
  <div class="max-w-4xl mx-auto mb-8">
    <div class="search-container">
      <form action="{{ url_for('search') }}" method="GET" onsubmit="hideSuggestions()">
        <input
          type="text"
          id="search-box"
          name="q"
          value="{{ query or '' }}"
          placeholder="Search services, helpers, or locations..."
          class="search-box"
          autocomplete="off"
          required
        />
        <button type="button" class="qr-btn" id="qr-toggle" aria-label="Scan QR">
          <i class="fas fa-qrcode"></i>
        </button>
        <button type="submit" class="search-btn">
          <img src="{{ url_for('static', filename='assets/search-icon.png') }}" alt="Search" />
        </button>
        <div id="search-suggestions" class="suggestions-box"></div>
      </form>
    </div>

    <!-- QR Scanner Panel -->
    <div id="qr-panel" style="display:none; margin: 20px auto; max-width: 600px;">
      <div id="qr-reader" style="width: 100%;"></div>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button type="button" id="qr-stop" class="qr-control" style="display:none;">Stop</button>
        <button type="button" id="qr-restart" class="qr-control" style="display:none;">Restart</button>
      </div>
      <div id="qr-results" class="qr-results" style="margin-top:10px;"></div>
      <div id="qr-error" class="qr-error" style="color:#b91c1c; margin-top:6px;"></div>
      <hr style="margin: 14px 0;">
    </div>

    <!-- Popular Searches Section -->
    <div class="search-categories mt-6">
      <h4 class="text-lg font-semibold text-gray-700 mb-4 text-center">Popular Searches</h4>
      <div class="category-tags">
        {% for service in trending_services[:6] %}
          <span class="category-tag" onclick="searchFor('{{ service }}')">{{ service }}</span>
        {% endfor %}
        {% if trending_services|length < 6 %}
          <span class="category-tag" onclick="searchFor('Cleaning')">Cleaning</span>
          <span class="category-tag" onclick="searchFor('Electrician')">Electrician</span>
          <span class="category-tag" onclick="searchFor('Plumbing')">Plumbing</span>
          <span class="category-tag" onclick="searchFor('Painting')">Painting</span>
          <span class="category-tag" onclick="searchFor('Carpentry')">Carpentry</span>
          <span class="category-tag" onclick="searchFor('Vehicle')">Vehicle Repair</span>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Results Section -->
  {% if query %}
  <div class="max-w-6xl mx-auto">
    <div class="mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">
        Search Results for "{{ query }}"
      </h2>
      <p class="text-gray-600">
        Found {{ (service_results|length if service_results else 0) + (business_results|length if business_results else 0) + (location_results|length if location_results else 0) }} result(s)
      </p>
    </div>

    <div class="space-y-8">
      <!-- Service Results -->
      {% if service_results %}
      <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex items-center mb-4">
          <i class="fas fa-tools text-blue-600 text-xl mr-3"></i>
          <h3 class="text-xl font-semibold text-gray-800">Services</h3>
          <span class="ml-2 bg-blue-100 text-blue-800 text-sm px-2 py-1 rounded-full">{{ service_results|length }}</span>
        </div>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
          {% for service in service_results %}
          <a href="{{ url_for('service', service_name=service.service_name) }}" 
             class="group block p-4 border-2 border-gray-200 rounded-xl shadow-sm hover:border-blue-300 hover:shadow-md transition-all duration-200 bg-gradient-to-br from-white to-gray-50">
            <div class="text-center">
              <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:bg-blue-200 transition-colors">
                <i class="fas fa-tools text-blue-600"></i>
              </div>
              <div class="font-semibold text-gray-800 group-hover:text-blue-700 transition-colors">{{ service.service_name }}</div>
            </div>
          </a>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Business Results -->
      {% if business_results %}
      <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex items-center mb-4">
          <i class="fas fa-user-tie text-green-600 text-xl mr-3"></i>
          <h3 class="text-xl font-semibold text-gray-800">Service Providers</h3>
          <span class="ml-2 bg-green-100 text-green-800 text-sm px-2 py-1 rounded-full">{{ business_results|length }}</span>
        </div>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          {% for business in business_results %}
          <a href="{{ url_for('profile', username=business.username) }}" 
             class="group block p-6 border-2 border-gray-200 rounded-xl shadow-sm hover:border-green-300 hover:shadow-lg transition-all duration-200 bg-gradient-to-br from-white to-green-50">
            <div class="text-center">
              <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-green-200 transition-colors">
                {% if business.profile_pic %}
                  <img src="{{ business.profile_pic }}" alt="{{ business.username }}" class="w-12 h-12 rounded-full object-cover">
                {% else %}
                  <i class="fas fa-user text-green-600 text-xl"></i>
                {% endif %}
              </div>
              <div class="font-bold text-gray-800 group-hover:text-green-700 transition-colors mb-1">{{ business.username }}</div>
              <div class="text-sm text-gray-600 mb-2">{{ business.business_type }}</div>
              <div class="text-xs text-gray-500 mb-3">{{ business.location }}</div>
              <div class="flex items-center justify-between text-sm">
                <div class="flex items-center text-yellow-500">
                  <i class="fas fa-star mr-1"></i>
                  <span class="font-medium">{{ business.rating or "N/A" }}</span>
                </div>
                <div class="text-green-600 font-semibold">
                  {{ business.price or "Contact" }}
                </div>
              </div>
            </div>
          </a>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Location Results -->
      {% if location_results %}
      <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex items-center mb-4">
          <i class="fas fa-map-marker-alt text-red-600 text-xl mr-3"></i>
          <h3 class="text-xl font-semibold text-gray-800">Locations</h3>
          <span class="ml-2 bg-red-100 text-red-800 text-sm px-2 py-1 rounded-full">{{ location_results|length }}</span>
        </div>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
          {% for location in location_results %}
          <div class="p-4 border-2 border-gray-200 rounded-xl shadow-sm bg-gradient-to-br from-white to-red-50">
            <div class="flex items-center">
              <i class="fas fa-map-marker-alt text-red-500 mr-3"></i>
              <span class="font-medium text-gray-800">{{ location.location_name }}</span>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- No Results -->
      {% if not service_results and not business_results and not location_results %}
      <div class="text-center py-12 bg-white rounded-xl shadow-lg">
        <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-search text-gray-400 text-3xl"></i>
        </div>
        <h3 class="text-xl font-semibold text-gray-700 mb-2">No results found</h3>
        <p class="text-gray-600 mb-4">We couldn't find anything matching "<strong>{{ query }}</strong>"</p>
        <div class="space-y-2 text-sm text-gray-500">
          <p>Try searching for:</p>
          <ul class="flex flex-wrap justify-center gap-2">
            <li>• Different keywords</li>
            <li>• Service names</li>
            <li>• Helper usernames</li>
            <li>• Location names</li>
          </ul>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}
<script>
  const searchBox = document.getElementById("search-box");
  const suggestionsBox = document.getElementById("search-suggestions");

  const placeholders = [
    "Search for House Cleaning",
    "Search for Electrician",
    "Search for username",
    "Search for location",
    "Search for Motor Repair",
    "Search for Kitchen Cleaning",
  ];

  // 🔄 Rotating placeholder
  let currentPlaceholder = 0;
  setInterval(() => {
    searchBox.setAttribute("placeholder", placeholders[currentPlaceholder]);
    currentPlaceholder = (currentPlaceholder + 1) % placeholders.length;
  }, 2000);

  // 🔎 Show suggestions on input
  searchBox.addEventListener("input", function () {
    const query = this.value.trim();

    if (!query) {
      hideSuggestions();
      return;
    }

    fetch(`/suggest?term=${encodeURIComponent(query)}`)
      .then((res) => res.json())
      .then((suggestions) => {
        suggestionsBox.innerHTML = "";

        if (suggestions.length === 0) {
          hideSuggestions();
          return;
        }

        suggestionsBox.style.display = "block";

        suggestions.forEach((item) => {
          const div = document.createElement("div");
          div.className = "suggestion-item";
          div.textContent = item;
          div.onclick = () => {
            searchBox.value = item;
            hideSuggestions();
            searchBox.form.submit(); // ✅ auto-search on click
          };
          suggestionsBox.appendChild(div);
        });
      })
      .catch(() => hideSuggestions());
  });

  // ⌨️ Hide on Enter & allow form submit
  searchBox.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      hideSuggestions();
    }
  });

  // 🚫 Hide when clicking outside
  document.addEventListener("click", (e) => {
    if (!suggestionsBox.contains(e.target) && e.target !== searchBox) {
      hideSuggestions();
    }
  });

  function hideSuggestions() {
    suggestionsBox.innerHTML = "";
    suggestionsBox.style.display = "none";
  }

  // Function for category tag search
  function searchFor(service) {
    searchBox.value = service;
    searchBox.form.submit();
  }
</script>

<!-- html5-qrcode CDN -->
<script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>
<script>
  // QR Scanner integration
  const qrToggleBtn = document.getElementById('qr-toggle');
  const qrPanel = document.getElementById('qr-panel');
  const qrReaderDiv = document.getElementById('qr-reader');
  const qrResults = document.getElementById('qr-results');
  const qrError = document.getElementById('qr-error');
  const qrStopBtn = document.getElementById('qr-stop');
  const qrRestartBtn = document.getElementById('qr-restart');
  const DEFAULT_AVATAR = "{{ url_for('static', filename='assets/default_profile.jpg') }}";
  let html5QrCode = null;
  let isRunning = false;

  function renderHelpers(helpers) {
    if (!helpers || helpers.length === 0) {
      qrResults.innerHTML = '<div class="qr-empty">No helpers found for this code.</div>';
      return;
    }
    qrResults.innerHTML = helpers.map(h => `
      <div class="helper-card">
        <img class="helper-avatar" src="${h.profile_pic || DEFAULT_AVATAR}" alt="${h.username}">
        <div class="helper-info">
          <div class="helper-name">${h.username}</div>
          <div class="helper-meta">${h.business_type || ''} • ${h.location || ''}</div>
          <div class="helper-meta">Phone: ${h.phone || 'N/A'} • Price: ${h.price || 'N/A'}</div>
          <div class="helper-rating">⭐ ${(h.avg_rating != null ? h.avg_rating : 0)}</div>
        </div>
        <a class="helper-view" href="/profile/${h.username}">View</a>
      </div>
    `).join('');
  }

  async function onScanSuccess(decodedText) {
    try {
      qrError.textContent = '';
      // Stop scanning once we have a code
      if (html5QrCode && isRunning) {
        await html5QrCode.stop();
        isRunning = false;
        qrStopBtn.style.display = 'none';
        qrRestartBtn.style.display = 'inline-block';
      }
      // Fetch helper(s) by code
      const res = await fetch(`/api/helper_by_code?code=${encodeURIComponent(decodedText)}`);
      if (!res.ok) throw new Error('Lookup failed');
      const data = await res.json();
      renderHelpers(data.helpers || []);
    } catch (e) {
      qrError.textContent = 'Failed to process QR. Please try again.';
    }
  }

  function onScanFailure(error) {
    // Ignore continuous scan errors; keep silent to avoid noise.
  }

  async function startScanner() {
    qrResults.innerHTML = '';
    qrError.textContent = '';
    if (!html5QrCode) {
      html5QrCode = new Html5Qrcode('qr-reader');
    }
    const configs = { fps: 10, qrbox: { width: 250, height: 250 } };
    try {
      // Preflight: explicitly request permission to trigger prompt and capture clearer errors
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        let preflightStream = null;
        try {
          preflightStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } } });
        } catch (permErr) {
          const errName = permErr && (permErr.name || permErr.message) || 'Camera error';
          const httpsWarning = location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1'
            ? ' Camera requires HTTPS in browsers.'
            : '';
          qrError.textContent = errName + '.' + httpsWarning;
          if (typeof showToast === 'function') {
            showToast(errName + '.' + httpsWarning, 'warning', 'QR Scanner');
          }
          throw permErr;
        } finally {
          // Immediately release the camera from preflight
          try {
            if (preflightStream) preflightStream.getTracks().forEach(t => t.stop());
          } catch (_) {}
        }
      }
      // Try preferred environment camera first
      await html5QrCode.start({ facingMode: 'environment' }, configs, onScanSuccess, onScanFailure);
      isRunning = true;
      qrStopBtn.style.display = 'inline-block';
      qrRestartBtn.style.display = 'none';
    } catch (e) {
      // Fallback: try first available camera
      try {
        const cameras = await Html5Qrcode.getCameras();
        if (cameras && cameras.length > 0) {
          await html5QrCode.start(cameras[0].id, configs, onScanSuccess, onScanFailure);
          isRunning = true;
          qrStopBtn.style.display = 'inline-block';
          qrRestartBtn.style.display = 'none';
        } else {
          throw new Error('No cameras found');
        }
      } catch (inner) {
        const httpsWarning = location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1'
          ? ' Note: Camera requires HTTPS in browsers.'
          : '';
        qrError.textContent = 'Camera access denied or unavailable.' + httpsWarning;
        if (typeof showToast === 'function') {
          showToast('Could not start the camera.' + httpsWarning, 'warning', 'QR Scanner');
        }
        console.error('QR start error:', e, inner);
      }
    }
  }

  qrToggleBtn.addEventListener('click', async () => {
    const isVisible = qrPanel.style.display !== 'none';
    qrPanel.style.display = isVisible ? 'none' : 'block';
    if (!isVisible) {
      await startScanner();
    } else if (html5QrCode && isRunning) {
      await html5QrCode.stop();
      isRunning = false;
    }
  });

  qrStopBtn.addEventListener('click', async () => {
    if (html5QrCode && isRunning) {
      await html5QrCode.stop();
      isRunning = false;
      qrStopBtn.style.display = 'none';
      qrRestartBtn.style.display = 'inline-block';
    }
  });

  qrRestartBtn.addEventListener('click', async () => {
    await startScanner();
  });

  // Suppress global unhandledrejection toast for html5-qrcode internals
  window.addEventListener('unhandledrejection', (e) => {
    try {
      const msg = String(e && e.reason || '');
      if (msg.includes('Html5Qrcode') || msg.includes('NotAllowedError')) {
        e.preventDefault();
      }
    } catch (_) {}
  }, { capture: true });
</script>
{% endblock %}
