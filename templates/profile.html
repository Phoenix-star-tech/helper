{% extends 'base.html' %}
{% block title %}Profile - Mr. Helper{% endblock %}
{% block content %}
<div class="profile-container">
  <div class="profile-header">
    <div class="profile-picture">
      {% if user.profile_pic %}
        <img src="{{ url_for('static', filename='uploads/' + user.profile_pic) }}" alt="Profile Picture" />
      {% else %}
        <img src="{{ url_for('static', filename='default_profile.png') }}" alt="Default Profile Picture" />
      {% endif %}
    </div>
    <div class="profile-info">
      <h2>{{ user.username }}</h2>
      <p>üìû {{ user.phone }}</p>
      {% if user.account_type == 'business' %}
        <p>üè¢ {{ user.business_type }}</p>
        <p>üìç {{ user.location }}</p>
        <p>üìù {{ user.bio }}</p>
        <p>üíµ {{ user.price if user.price else 'Not provided' }}</p>
      {% endif %}
    </div>
    {% if session['username'] == user.username %}
      <a href="{{ url_for('edit_profile') }}" class="btn edit-btn">Edit Profile</a>
    {% endif %}
  </div>

  <div class="ratings-summary">
    {% set total_rating = 0 %}
    {% set rating_count = 0 %}
    {% for fb in feedback %}
      {% set total_rating = total_rating + fb['rating'] %}
      {% set rating_count = rating_count + 1 %}
    {% endfor %}
    
    {% if rating_count > 0 %}
      <p>‚≠ê Average Rating: <strong>{{ (total_rating / rating_count)|round(1) }}/5</strong> ({{ rating_count }} reviews)</p>
    {% else %}
      <p>No ratings yet</p>
    {% endif %}
  </div>

  {% if session['username'] != user.username %}
    <div class="rating-section">
      <h3>Rate & Comment</h3>
      {% if not has_rated %}
        <form method="POST" action="{{ url_for('rate_comment', username=user.username) }}">
          <div class="star-rating">
            {% for i in range(5, 0, -1) %}
              <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" required />
              <label for="star{{ i }}">‚òÖ</label>
            {% endfor %}
          </div>
          <textarea name="comment" placeholder="Leave a comment..." required></textarea>
          <button type="submit" class="btn">Submit</button>
        </form>
      {% else %}
        <p>You already rated this user.</p>
        <form method="POST" action="{{ url_for('delete_rating', username=user.username) }}">
          <button type="submit" class="btn delete-btn">Delete Rating</button>
        </form>
      {% endif %}
    </div>
  {% endif %}

  <div class="feedback-section">
    <h3>Feedback</h3>
    {% for fb in feedback %}
      <div class="feedback-card">
        <p><strong>{{ fb['from_user'] }}</strong> rated {{ fb['rating'] }}/5</p>
        <p>{{ fb['comment'] }}</p>
        {% if fb['reply'] %}
          <p class="reply">Reply: {{ fb['reply'] }}</p>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  {% if session['username'] != user.username and not is_admin %}
    <div class="report-section">
      <h3>Report Profile</h3>
      <form method="POST" action="{{ url_for('report', username=user.username) }}">
        <textarea name="reason" placeholder="Reason for reporting..." required></textarea>
        <button type="submit" class="btn report-btn">Report</button>
      </form>
    </div>
  {% endif %}

  {% if session['username'] == user.username %}
    <div class="orders-section">
      <h3>Past Orders</h3>
      {% if orders %}
        {% for o in orders %}
          <p>üìù {{ o['service'] }} in {{ o['location'] }} ‚Äî {{ o['timestamp'] }}</p>
        {% endfor %}
      {% else %}
        <p>No orders placed yet.</p>
      {% endif %}
    </div>

    <div class="notifications-section">
      <h3>Notifications</h3>
      {% if notifications %}
        {% for note in notifications %}
          <div class="notification-card">
            <p><strong>{{ note['user'] }}</strong> ordered <strong>{{ note['service'] }}</strong> at <strong>{{ note['location'] }}</strong></p>
            <p>{{ note['message'] }}</p>
            {% if note['image'] %}
              <img src="{{ url_for('static', filename='uploads/' + note['image']) }}" />
            {% endif %}
            <p class="timestamp">{{ note['timestamp'] }}</p>

            {% if session['username'] != note['user'] %}
              {% if not note['provider_accepted'] %}
                <form method="POST" action="{{ url_for('order', service=service_name) }}">
                  <input type="hidden" name="order_id" value="{{ note['order_id'] }}" />
                  <button type="submit" class="btn accept-btn">Accept Request</button>
                </form>
              {% else %}
                <p class="accepted">Accepted ‚úÖ</p>
              {% endif %}
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <p>No notifications.</p>
      {% endif %}
    </div>
  {% endif %}

  {% if reports %}
    <div class="report-warning">
      <p>‚ö†Ô∏è This user has been reported:</p>
      <ul>
        {% for report in reports %}
          <li>{{ report.reason }}</li>
        {% endfor %}
      </ul>
    </div>
  {% else %}
    <div class="no-reports">
      <p>‚úÖ No reports found.</p>
    </div>
  {% endif %}

  {% if session['username'] == user.username %}
    <a href="{{ url_for('logout') }}" class="btn logout-btn">Logout</a>
  {% endif %}
</div>

<!-- Styling -->
<style>
.profile-container {
  max-width: 900px;
  margin: auto;
  padding: 2rem;
}
.profile-header {
  display: flex;
  align-items: center;
  gap: 2rem;
  margin-bottom: 2rem;
}
.profile-picture img {
  width: 120px;
  height: 120px;
  object-fit: cover;
  border-radius: 50%;
  border: 3px solid #4f46e5;
}
.profile-info h2 {
  margin: 0;
}
.btn {
  background-color: #4f46e5;
  color: white;
  padding: 10px 20px;
  margin-top: 1rem;
  display: inline-block;
  text-decoration: none;
  border-radius: 10px;
}
.edit-btn {
  background-color: #10b981;
}
.delete-btn {
  background-color: #f59e0b;
}
.report-btn {
  background-color: #ef4444;
}
.accept-btn {
  background-color: #10b981;
}
.logout-btn {
  background-color: #ef4444;
  width: 100%;
  text-align: center;
}
.ratings-summary,
.rating-section,
.feedback-section,
.report-section,
.orders-section,
.notifications-section,
.report-warning,
.no-reports {
  margin-bottom: 2rem;
}
.feedback-card,
.notification-card {
  background-color: #f9fafb;
  border: 1px solid #e5e7eb;
  padding: 1rem;
  border-radius: 10px;
  margin-top: 1rem;
}
.notification-card img {
  width: 100px;
  height: 100px;
  object-fit: cover;
  margin-top: 1rem;
}
.star-rating input[type="radio"] {
  display: none;
}
.star-rating label {
  font-size: 30px;
  color: #ccc;
  cursor: pointer;
}
.star-rating input[type="radio"]:checked ~ label,
.star-rating label:hover,
.star-rating label:hover ~ label {
  color: gold;
}
textarea {
  width: 100%;
  padding: 10px;
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  margin-top: 10px;
}
.timestamp {
  font-size: 0.8rem;
  color: gray;
}
.reply {
  font-style: italic;
  color: #6b7280;
}
@media (max-width: 768px) {
  .profile-header {
    flex-direction: column;
    text-align: center;
  }
  .profile-picture img {
    width: 100px;
    height: 100px;
  }
}
</style>
{% endblock %}
