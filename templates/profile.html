{% extends 'base.html' %}
{% block title %}Profile - Mr. Helper{% endblock %}
{% block content %}

<div class="container mt-4">
  <div class="card p-4">
    <div class="text-center">
      {% if user.profile_pic %}
        <img src="{{ url_for('static', filename='uploads/' + user.profile_pic) }}" class="rounded-circle mb-3" alt="Profile Picture" width="120" height="120" />
      {% else %}
        <img src="{{ url_for('static', filename='default_profile.png') }}" class="rounded-circle mb-3" alt="Default Profile Picture" width="120" height="120" />
      {% endif %}
      <h3>{{ user.username }}</h3>
      <p><i class="fas fa-phone"></i> {{ user.phone }}</p>
    </div>

    {% if user.account_type == 'business' %}
      <hr>
      <p><i class="fas fa-briefcase"></i> Business Type: <strong>{{ user.business_type }}</strong></p>
      <p><i class="fas fa-map-marker-alt"></i> Location: <strong>{{ user.location }}</strong></p>
      <p><i class="fas fa-info-circle"></i> Bio: {{ user.bio }}</p>
      <p><i class="fas fa-dollar-sign"></i> Price: <strong>{{ user.price if user.price else 'Not provided' }}</strong></p>

      {% if session['username'] == user.username %}
        <div class="text-center my-3">
          <a href="{{ url_for('edit_profile') }}" class="btn btn-primary"><i class="fas fa-edit"></i> Edit Profile</a>
        </div>
      {% endif %}
    {% endif %}

    <hr>

    <!-- Average Rating -->
    {% set total_rating = 0 %}
    {% set rating_count = 0 %}
    {% for fb in feedback %}
      {% set total_rating = total_rating + fb['rating'] %}
      {% set rating_count = rating_count + 1 %}
    {% endfor %}

    {% if rating_count > 0 %}
      <p><i class="fas fa-star text-warning"></i> Average Rating: <strong>{{ (total_rating / rating_count)|round(1) }}/5</strong> ({{ rating_count }} ratings)</p>
    {% else %}
      <p><i class="fas fa-star"></i> No ratings yet</p>
    {% endif %}
  </div>

  <!-- Rating and Comment Form -->
  {% if session['username'] != user.username %}
    <div class="card mt-4 p-4">
      <h4>Rate & Comment</h4>
      {% if not has_rated %}
        <form method="POST" action="{{ url_for('rate_comment', username=user.username) }}">
          <div class="mb-3">
            <label class="form-label">Your Rating:</label>
            <div class="rating">
              {% for i in range(5, 0, -1) %}
                <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" required />
                <label for="star{{ i }}">‚òÖ</label>
              {% endfor %}
            </div>
          </div>
          <div class="mb-3">
            <textarea name="comment" class="form-control" placeholder="Leave a comment..." required></textarea>
          </div>
          <button type="submit" class="btn btn-success">Submit</button>
        </form>
      {% else %}
        <p class="text-warning">You already rated this user.</p>
        <form method="POST" action="{{ url_for('delete_rating', username=user.username) }}">
          <button type="submit" class="btn btn-danger">Delete Rating</button>
        </form>
      {% endif %}
    </div>
  {% endif %}

  <!-- Feedback Section -->
  <div class="card mt-4 p-4">
    <h3>Feedback</h3>
    {% for fb in feedback %}
      <div class="border rounded p-3 mb-3">
        <p><strong>{{ fb['from_user'] }}</strong> rated <span class="text-warning">{{ fb['rating'] }}/5</span></p>
        <p>{{ fb['comment'] }}</p>
        {% if fb['reply'] %}
          <div class="alert alert-info p-2 mt-2"><em>Reply:</em> {{ fb['reply'] }}</div>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <!-- Report Section -->
  {% if session['username'] != user.username and not is_admin %}
    <div class="card mt-4 p-4">
      <h3>Report this Profile</h3>
      <form method="POST" action="{{ url_for('report', username=user.username) }}">
        <div class="mb-3">
          <textarea name="reason" class="form-control" placeholder="Why are you reporting this profile?" required></textarea>
        </div>
        <button type="submit" class="btn btn-danger"><i class="fas fa-flag"></i> Report</button>
      </form>
    </div>
  {% endif %}

  <!-- Orders and Notifications -->
  {% if session['username'] == user.username %}
    <div class="card mt-4 p-4">
      <h3>üõí Past Orders</h3>
      {% if orders %}
        {% for o in orders %}
          <p>üìù <strong>{{ o['service'] }}</strong> in <em>{{ o['location'] }}</em> ‚Äî <small>{{ o['timestamp'] }}</small></p>
        {% endfor %}
      {% else %}
        <p>No orders placed yet.</p>
      {% endif %}
    </div>

    <div class="card mt-4 p-4">
      <h3>üîî Notifications</h3>
      {% if notifications %}
        {% for note in notifications %}
          <div class="border rounded p-3 mb-3">
            <p><strong>{{ note['user'] }}</strong> ordered <strong>{{ note['service'] }}</strong> at <strong>{{ note['location'] }}</strong></p>
            <p>{{ note['message'] }}</p>
            {% if note['image'] %}
              <img src="{{ url_for('static', filename='uploads/' + note['image']) }}" class="img-fluid mb-2" width="120" />
            {% endif %}
            <small>{{ note['timestamp'] }}</small><br>
            {% if session['username'] == note['user'] %}
              {% if not note['provider_accepted'] %}
                <p class="badge bg-warning text-dark">Waiting for provider to accept</p>
              {% else %}
                <p class="badge bg-success">Order accepted</p>
              {% endif %}
            {% else %}
              {% if not note['provider_accepted'] %}
                <form method="POST" action="{{ url_for('order', service=service_name) }}">
                  <input type="hidden" name="order_id" value="{{ note['order_id'] }}" />
                  <button type="submit" class="btn btn-success btn-sm">Accept Request</button>
                </form>
              {% else %}
                <span class="badge bg-success">Accepted</span>
              {% endif %}
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <p>No new notifications.</p>
      {% endif %}
    </div>
  {% endif %}

  <!-- Reports for Admin -->
  {% if reports %}
    <div class="alert alert-danger mt-4">
      ‚ö†Ô∏è This user has been reported:
      <ul>
        {% for report in reports %}
          <li>{{ report.reason }}</li>
        {% endfor %}
      </ul>
    </div>
  {% else %}
    <div class="alert alert-success mt-4">
      ‚úÖ No reports found.
    </div>
  {% endif %}

  <!-- Logout -->
  {% if session['username'] == user.username %}
    <div class="text-center mt-4">
      <a href="{{ url_for('logout') }}" class="btn btn-outline-danger"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>
  {% endif %}
</div>

<!-- Styles for rating stars -->
<style>
.rating {
  display: flex;
  flex-direction: row-reverse;
  justify-content: center;
}
.rating input {
  display: none;
}
.rating label {
  font-size: 2rem;
  color: #ddd;
  cursor: pointer;
}
.rating input:checked ~ label,
.rating label:hover,
.rating label:hover ~ label {
  color: gold;
}
</style>

{% endblock %}
