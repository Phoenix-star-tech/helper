{% extends 'base.html' %}

{% block title %}Place Order - Mr. Helper{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto mt-6 p-6 bg-white rounded-2xl shadow-lg">
  <!-- Header Section -->
  <div class="text-center mb-8">
    <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
      <i class="fas fa-clipboard-list text-2xl text-blue-600"></i>
    </div>
    <h2 class="text-3xl font-bold text-gray-800 mb-2">Place Service Order</h2>
    <p class="text-gray-600">Get professional help for your needs</p>
  </div>

  <form method="POST" enctype="multipart/form-data" class="space-y-6" id="orderForm">
    
    <!-- Customer Info Section -->
    <div class="bg-gray-50 p-4 rounded-xl">
      <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
        <i class="fas fa-user mr-2 text-blue-600"></i>
        Customer Information
      </h3>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
        <input type="text" value="{{ session['username'] }}" disabled
               class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-100 cursor-not-allowed text-gray-600">
      </div>
    </div>

    <!-- Service Selection Section -->
    <div class="bg-blue-50 p-4 rounded-xl">
      <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
        <i class="fas fa-tools mr-2 text-blue-600"></i>
        Service Details
      </h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Service selection -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Service Type *</label>
          <select name="service" required id="serviceSelect"
                  class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
            <option value="" disabled selected>Choose a service</option>
            {% for s in services %}
              <option value="{{ s['service_name'] }}">
                {{ s['service_name'] }}
              </option>
            {% endfor %}
          </select>
          <div id="serviceDescription" class="mt-2 text-sm text-gray-600 hidden"></div>
        </div>

        <!-- Priority Level -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Priority Level</label>
          <select name="priority" id="prioritySelect"
                  class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
            <option value="normal" selected>Normal (1-2 days)</option>
            <option value="urgent">Urgent (Same day)</option>
            <option value="emergency">Emergency (ASAP)</option>
          </select>
        </div>
      </div>

      <!-- Location selection -->
      <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Service Location *</label>
        <select name="location" required
                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
          <option value="" disabled selected>Select your location</option>
          {% for loc in locations %}
            <option value="{{ loc['location_name'] }}">{{ loc['location_name'] }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Preferred Time -->
      <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Preferred Time</label>
        <div class="grid grid-cols-2 gap-3">
          <select name="preferred_date" class="px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="">Any date</option>
            <option value="today">Today</option>
            <option value="tomorrow">Tomorrow</option>
            <option value="this_week">This week</option>
            <option value="next_week">Next week</option>
          </select>
          <select name="preferred_time" class="px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="">Any time</option>
            <option value="morning">Morning (8AM-12PM)</option>
            <option value="afternoon">Afternoon (12PM-5PM)</option>
            <option value="evening">Evening (5PM-8PM)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Service Description Section -->
    <div class="bg-green-50 p-4 rounded-xl">
      <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
        <i class="fas fa-comment-alt mr-2 text-green-600"></i>
        Service Description
      </h3>
      
      <!-- Message textarea -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Describe your request *</label>
        <textarea name="message" rows="4" placeholder="Please provide detailed information about the service you need..."
                  required class="w-full px-4 py-3 border border-gray-300 rounded-xl resize-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"></textarea>
        <div class="text-xs text-gray-500 mt-1">Be specific about your requirements for better service</div>
      </div>

      <!-- Image upload -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Upload Photos (Optional)</label>
        <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-blue-400 transition-colors">
          <input type="file" name="image" id="imageUpload" accept="image/*" multiple
                 class="hidden">
          <label for="imageUpload" class="cursor-pointer">
            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
            <p class="text-gray-600">Click to upload photos or drag and drop</p>
            <p class="text-xs text-gray-500 mt-1">PNG, JPG, JPEG, GIF up to 10MB each</p>
          </label>
        </div>
        <div id="imagePreview" class="mt-3 grid grid-cols-2 gap-2 hidden"></div>
      </div>
    </div>

    <!-- Budget Section -->
    <div class="bg-yellow-50 p-4 rounded-xl">
      <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
        <i class="fas fa-rupee-sign mr-2 text-yellow-600"></i>
        Budget Information
      </h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Estimated Budget (â‚¹)</label>
          <input type="number" name="budget" placeholder="e.g., 500"
                 class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all">
          <div class="text-xs text-gray-500 mt-1">Optional - helps providers give accurate quotes</div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Payment Preference</label>
          <select name="payment_preference" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
            <option value="cash" selected>Cash</option>
            <option value="online">Online Payment</option>
            <option value="both">Both</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Contact Information -->
    <div class="bg-purple-50 p-4 rounded-xl">
      <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
        <i class="fas fa-phone mr-2 text-purple-600"></i>
        Contact Information
      </h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
          <input type="tel" name="phone" placeholder="Your contact number"
                 class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Best Time to Call</label>
          <select name="call_time" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            <option value="anytime">Anytime</option>
            <option value="morning">Morning (8AM-12PM)</option>
            <option value="afternoon">Afternoon (12PM-5PM)</option>
            <option value="evening">Evening (5PM-8PM)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Terms and Conditions -->
    <div class="bg-gray-50 p-4 rounded-xl">
      <div class="flex items-start">
        <input type="checkbox" id="terms" required class="mt-1 mr-3">
        <label for="terms" class="text-sm text-gray-700">
          I agree to the <a href="#" class="text-blue-600 hover:underline">Terms of Service</a> and 
          <a href="#" class="text-blue-600 hover:underline">Privacy Policy</a>. I understand that service providers will contact me directly.
        </label>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="text-center pt-4">
      <button type="submit" id="submitBtn"
              class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-8 py-4 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-105 flex items-center justify-center mx-auto">
        <i class="fas fa-paper-plane mr-2"></i>
        <span>Place Order</span>
        <i class="fas fa-spinner fa-spin ml-2 hidden" id="submitSpinner"></i>
      </button>
      <p class="text-xs text-gray-500 mt-2">Your order will be sent to qualified service providers in your area</p>
    </div>
  </form>
</div>

<!-- Order Confirmation Modal -->
<div id="orderModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-check-circle text-green-500"></i> Order Confirmation</h3>
    </div>
    <div class="modal-body">
      <p>Your order has been successfully placed!</p>
      <p class="modal-subtext">Service providers will be notified and you'll receive updates via notifications.</p>
    </div>
    <div class="modal-footer">
      <button class="modal-btn confirm-btn" onclick="closeOrderModal()">
        <i class="fas fa-check"></i>
        <span>Great!</span>
      </button>
    </div>
  </div>
</div>

<style>
  .modal {
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
  }
  
  .modal.hidden {
    display: none;
  }
  
  .modal-content {
    background-color: white;
    margin: 15% auto;
    padding: 0;
    border-radius: 15px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease;
  }
  
  @keyframes modalSlideIn {
    from {
      transform: translateY(-50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
  
  .modal-header {
    padding: 20px 25px 15px;
    border-bottom: 1px solid #eee;
  }
  
  .modal-header h3 {
    margin: 0;
    color: #333;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .modal-body {
    padding: 20px 25px;
  }
  
  .modal-body p {
    margin: 0 0 10px 0;
    color: #555;
    font-size: 1rem;
  }
  
  .modal-subtext {
    color: #666;
    font-size: 0.9rem;
  }
  
  .modal-footer {
    padding: 15px 25px 20px;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }
  
  .modal-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    text-decoration: none;
    transition: all 0.2s ease;
  }
  
  .confirm-btn {
    background: #10b981;
    color: white;
  }
  
  .confirm-btn:hover {
    background: #059669;
  }
  
  #imagePreview img {
    width: 100%;
    height: 100px;
    object-fit: cover;
    border-radius: 8px;
  }
</style>

<script>
  // Service description display
  document.getElementById('serviceSelect').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const description = selectedOption.getAttribute('data-description');
    const descriptionDiv = document.getElementById('serviceDescription');
    
    if (description) {
      descriptionDiv.textContent = description;
      descriptionDiv.classList.remove('hidden');
    } else {
      descriptionDiv.classList.add('hidden');
    }
  });

  // Image preview functionality with size validation
  document.getElementById('imageUpload').addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    const preview = document.getElementById('imagePreview');
    const maxSize = 10 * 1024 * 1024; // 10MB
    
    if (files.length > 0) {
      preview.classList.remove('hidden');
      preview.innerHTML = '';
      
      let hasValidFiles = false;
      
      files.forEach(file => {
        if (file.type.startsWith('image/')) {
          if (file.size > maxSize) {
            alert(`File "${file.name}" is too large. Please select files smaller than 10MB.`);
            return;
          }
          
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'border rounded-lg';
            preview.appendChild(img);
          };
          reader.readAsDataURL(file);
          hasValidFiles = true;
        } else {
          alert(`File "${file.name}" is not a valid image format. Please select PNG, JPG, JPEG, or GIF files.`);
        }
      });
      
      if (!hasValidFiles) {
        preview.classList.add('hidden');
        e.target.value = ''; // Clear the input
      }
    } else {
      preview.classList.add('hidden');
    }
  });

  // Form submission with loading state
  document.getElementById('orderForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    const spinner = document.getElementById('submitSpinner');
    
    // Show loading state
    submitBtn.disabled = true;
    spinner.classList.remove('hidden');
    submitBtn.querySelector('span').textContent = 'Placing Order...';
  });

  // Priority level styling
  document.getElementById('prioritySelect').addEventListener('change', function() {
    const priority = this.value;
    const serviceSection = this.closest('.bg-blue-50');
    
    // Remove existing priority classes
    serviceSection.classList.remove('border-red-200', 'border-yellow-200', 'border-green-200');
    
    // Add appropriate styling based on priority
    switch(priority) {
      case 'emergency':
        serviceSection.classList.add('border-red-200', 'border-2');
        break;
      case 'urgent':
        serviceSection.classList.add('border-yellow-200', 'border-2');
        break;
      case 'normal':
        serviceSection.classList.add('border-green-200', 'border-2');
        break;
    }
  });

  function closeOrderModal() {
    document.getElementById('orderModal').classList.add('hidden');
  }

  // Form validation
  function validateForm() {
    const requiredFields = ['service', 'location', 'message'];
    let isValid = true;
    
    requiredFields.forEach(field => {
      const element = document.querySelector(`[name="${field}"]`);
      if (!element.value.trim()) {
        element.classList.add('border-red-500');
        isValid = false;
      } else {
        element.classList.remove('border-red-500');
      }
    });
    
    return isValid;
  }

  // Real-time validation
  document.querySelectorAll('input[required], select[required], textarea[required]').forEach(element => {
    element.addEventListener('blur', function() {
      if (!this.value.trim()) {
        this.classList.add('border-red-500');
      } else {
        this.classList.remove('border-red-500');
      }
    });
  });
</script>
{% endblock %}
