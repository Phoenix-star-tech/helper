{% extends 'base.html' %}

{% block title %}My Orders - Mr. Helper{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto mt-6 p-6">
  <!-- Header -->
  <div class="text-center mb-8">
    <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
      <i class="fas fa-clipboard-list text-2xl text-blue-600"></i>
    </div>
    <h2 class="text-3xl font-bold text-gray-800 mb-2">My Orders</h2>
    <p class="text-gray-600">Track and manage your service orders</p>
  </div>

  {% if orders %}
    <div class="grid gap-6">
      {% for order in orders %}
      <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 
                  {% if order.priority == 'emergency' %}border-red-500
                  {% elif order.priority == 'urgent' %}border-yellow-500
                  {% else %}border-blue-500{% endif %}">
        
        <!-- Order Header -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
          <div>
            <h3 class="text-xl font-semibold text-gray-800 mb-1">
              {{ order.service_name }} Service
            </h3>
            <div class="flex items-center gap-4 text-sm text-gray-600">
              <span class="flex items-center">
                <i class="fas fa-map-marker-alt mr-1"></i>
                {{ order.location_name }}
              </span>
              <span class="flex items-center">
                <i class="fas fa-calendar mr-1"></i>
                {{ order.created_at.strftime('%B %d, %Y at %I:%M %p') }}
              </span>
            </div>
          </div>
          
          <div class="flex items-center gap-3 mt-3 md:mt-0">
            <!-- Priority Badge -->
            <span class="px-3 py-1 rounded-full text-xs font-medium
                        {% if order.priority == 'emergency' %}bg-red-100 text-red-800
                        {% elif order.priority == 'urgent' %}bg-yellow-100 text-yellow-800
                        {% else %}bg-green-100 text-green-800{% endif %}">
              {% if order.priority == 'emergency' %}ðŸš¨ Emergency
              {% elif order.priority == 'urgent' %}âš¡ Urgent
              {% else %}ðŸ“‹ Normal{% endif %}
            </span>
            
            <!-- Status Badge -->
            <span class="px-3 py-1 rounded-full text-xs font-medium
                        {% if order.status == 'completed' %}bg-green-100 text-green-800
                        {% elif order.status == 'in_progress' %}bg-blue-100 text-blue-800
                        {% elif order.status == 'cancelled' %}bg-red-100 text-red-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
              {{ order.status.replace('_', ' ').title() }}
            </span>
          </div>
        </div>

        <!-- Order Details -->
        <div class="mb-4">
          <p class="text-gray-700 mb-3">{{ order.message[:200] }}{% if order.message|length > 200 %}...{% endif %}</p>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
            {% if order.budget %}
            <div class="flex items-center">
              <i class="fas fa-rupee-sign text-green-600 mr-2"></i>
              <span class="text-gray-600">Budget: â‚¹{{ order.budget }}</span>
            </div>
            {% endif %}
            
            <div class="flex items-center">
              <i class="fas fa-credit-card text-blue-600 mr-2"></i>
              <span class="text-gray-600">Payment: {{ order.payment_preference.replace('_', ' ').title() }}</span>
            </div>
            
            <div class="flex items-center">
              <i class="fas fa-users text-purple-600 mr-2"></i>
              <span class="text-gray-600">{{ order.accepted_count }} provider(s) interested</span>
            </div>
          </div>
        </div>

        <!-- Selected Provider -->
        {% if order.selected_provider %}
        <div class="bg-green-50 p-3 rounded-lg mb-4">
          <div class="flex items-center">
            <i class="fas fa-check-circle text-green-600 mr-2"></i>
            <span class="text-green-800 font-medium">Selected Provider: {{ order.selected_provider }}</span>
          </div>
        </div>
        {% endif %}

        <!-- Tracking Timeline -->
        {% if order.tracking %}
        <div class="mb-4">
          <h4 class="text-sm font-medium text-gray-700 mb-2">Order Timeline</h4>
          <div class="space-y-2">
            {% for track in order.tracking[:3] %}
            <div class="flex items-center text-xs text-gray-600">
              <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
              <span>{{ track.status.replace('_', ' ').title() }}</span>
              <span class="ml-auto">{{ track.created_at.strftime('%m/%d %I:%M %p') }}</span>
            </div>
            {% endfor %}
            {% if order.tracking|length > 3 %}
            <div class="text-xs text-gray-500 ml-5">
              +{{ order.tracking|length - 3 }} more updates
            </div>
            {% endif %}
          </div>
        </div>
        {% endif %}

        <!-- Actions -->
        <div class="flex flex-col sm:flex-row gap-3">
          <a href="{{ url_for('order_details', order_id=order.id) }}" 
             class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-center transition-colors">
            <i class="fas fa-eye mr-2"></i>View Details
          </a>
          
          {% if not order.status or order.status == 'pending' %}
          <button onclick="cancelOrder({{ order.id }})" 
                  class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors"
                  style="cursor: pointer;">
            <i class="fas fa-times mr-2"></i>Cancel Order
          </button>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <!-- Empty State -->
    <div class="text-center py-12">
      <div class="inline-flex items-center justify-center w-24 h-24 bg-gray-100 rounded-full mb-6">
        <i class="fas fa-clipboard-list text-3xl text-gray-400"></i>
      </div>
      <h3 class="text-xl font-semibold text-gray-800 mb-2">No Orders Yet</h3>
      <p class="text-gray-600 mb-6">You haven't placed any service orders yet.</p>
      <a href="{{ url_for('place_order') }}" 
         class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-colors">
        <i class="fas fa-plus mr-2"></i>Place Your First Order
      </a>
    </div>
  {% endif %}
</div>

<!-- Cancel Order Modal -->
<div id="cancelModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-exclamation-triangle text-red-500"></i> Cancel Order</h3>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to cancel this order?</p>
      <p class="modal-subtext">This action cannot be undone. Any accepted providers will be notified.</p>
    </div>
    <div class="modal-footer">
      <button class="modal-btn cancel-btn" onclick="closeCancelModal()">
        <i class="fas fa-times"></i>
        <span>Keep Order</span>
      </button>
      <button class="modal-btn confirm-btn bg-red-600 hover:bg-red-700" onclick="confirmCancelOrder()">
        <i class="fas fa-check"></i>
        <span>Cancel Order</span>
      </button>
    </div>
  </div>
</div>

<style>
  .modal {
    position: fixed;
    z-index: 99999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .modal.hidden {
    display: none !important;
  }
  
  .modal-content {
    background-color: white;
    margin: 0;
    padding: 0;
    border-radius: 15px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease;
    position: relative;
    z-index: 100000;
  }
  
  @keyframes modalSlideIn {
    from {
      transform: translateY(-50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
  
  .modal-header {
    padding: 20px 25px 15px;
    border-bottom: 1px solid #eee;
  }
  
  .modal-header h3 {
    margin: 0;
    color: #333;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .modal-body {
    padding: 20px 25px;
  }
  
  .modal-body p {
    margin: 0 0 10px 0;
    color: #555;
    font-size: 1rem;
  }
  
  .modal-subtext {
    color: #666;
    font-size: 0.9rem;
  }
  
  .modal-footer {
    padding: 15px 25px 20px;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }
  
  .modal-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    text-decoration: none;
    transition: all 0.2s ease;
  }
  
  .cancel-btn {
    background: #f3f4f6;
    color: #374151;
  }
  
  .cancel-btn:hover {
    background: #e5e7eb;
  }
  
  .confirm-btn {
    background: #10b981;
    color: white;
  }
  
  .confirm-btn:hover {
    background: #059669;
  }
</style>

<script>
  let orderToCancel = null;

  function cancelOrder(orderId) {
    console.log('Cancel order clicked for order ID:', orderId);
    orderToCancel = orderId;
    const modal = document.getElementById('cancelModal');
    if (modal) {
      console.log('Modal found, current classes:', modal.className);
      modal.classList.remove('hidden');
      console.log('Modal classes after removing hidden:', modal.className);
      console.log('Modal display style:', window.getComputedStyle(modal).display);
      console.log('Modal visibility style:', window.getComputedStyle(modal).visibility);
      
      // Force modal to be visible as a test
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.zIndex = '99999';
      console.log('Forced modal to be visible');
    } else {
      console.error('Cancel modal not found!');
    }
  }

  function closeCancelModal() {
    document.getElementById('cancelModal').classList.add('hidden');
    orderToCancel = null;
  }

  function confirmCancelOrder() {
    console.log('Confirm cancel order for ID:', orderToCancel);
    if (orderToCancel) {
      // Create a form and submit it
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/cancel_order/${orderToCancel}`;
      
      console.log('Submitting form to:', form.action);
      document.body.appendChild(form);
      form.submit();
    } else {
      console.error('No order ID to cancel!');
    }
  }

  // Close modal when clicking outside
  window.onclick = function(event) {
    const modal = document.getElementById('cancelModal');
    if (event.target === modal) {
      closeCancelModal();
    }
  }

  // Close modal with Escape key
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      closeCancelModal();
    }
  });
</script>
{% endblock %}
