{% extends 'base.html' %}

{% block title %}Order Details - Mr. Helper{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-bold">Order Details #{{ order.id }}</h2>
    <a href="{{ url_for('notifications') }}" class="text-blue-600 hover:text-blue-800 text-sm">
      ‚Üê Back to Notifications
    </a>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Order Information -->
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h3 class="text-xl font-semibold mb-4 text-gray-800">Order Information</h3>
      
      <div class="space-y-4">
        <div class="flex justify-between">
          <span class="font-medium text-gray-600">Service:</span>
          <span class="text-gray-800">{{ order.service_name }}</span>
        </div>
        
        <div class="flex justify-between">
          <span class="font-medium text-gray-600">Location:</span>
          <span class="text-gray-800">{{ order.location_name }}</span>
        </div>
        
        <div class="flex justify-between">
          <span class="font-medium text-gray-600">Priority:</span>
          <span class="px-2 py-1 rounded-full text-xs font-medium
            {% if order.priority == 'emergency' %}bg-red-100 text-red-800
            {% elif order.priority == 'urgent' %}bg-yellow-100 text-yellow-800
            {% else %}bg-green-100 text-green-800{% endif %}">
            {{ order.priority.title() }}
          </span>
        </div>
        
        <div class="flex justify-between">
          <span class="font-medium text-gray-600">Status:</span>
          <span class="px-2 py-1 rounded-full text-xs font-medium
            {% if order.status == 'completed' %}bg-green-100 text-green-800
            {% elif order.status == 'in_progress' %}bg-blue-100 text-blue-800
            {% else %}bg-yellow-100 text-yellow-800{% endif %}">
            {{ order.status.title() }}
          </span>
        </div>
        
        {% if order.budget %}
        <div class="flex justify-between">
          <span class="font-medium text-gray-600">Budget:</span>
          <span class="text-gray-800">‚Çπ{{ "%.0f"|format(order.budget) }}</span>
        </div>
        {% endif %}
        
        {% if order.payment_preference %}
        <div class="flex justify-between">
          <span class="font-medium text-gray-600">Payment:</span>
          <span class="text-gray-800">{{ order.payment_preference.title() }}</span>
        </div>
        {% endif %}
        
        {% if order.preferred_date %}
        <div class="flex justify-between">
          <span class="font-medium text-gray-600">Preferred Date:</span>
          <span class="text-gray-800">{{ order.preferred_date }}</span>
        </div>
        {% endif %}
        
        {% if order.preferred_time %}
        <div class="flex justify-between">
          <span class="font-medium text-gray-600">Preferred Time:</span>
          <span class="text-gray-800">{{ order.preferred_time }}</span>
        </div>
        {% endif %}
        
        <div class="flex justify-between">
          <span class="font-medium text-gray-600">Created:</span>
          <span class="text-gray-800">{{ order.created_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
        </div>
      </div>
      
      <!-- Order Description -->
      <div class="mt-6">
        <h4 class="font-medium text-gray-600 mb-2">Description:</h4>
        <p class="text-gray-800 bg-gray-50 p-3 rounded-lg">{{ order.message }}</p>
      </div>
      
      <!-- Order Image -->
      {% if order.image_path %}
      <div class="mt-6">
        <h4 class="font-medium text-gray-600 mb-2">Image:</h4>
        <img src="{{ order.image_path }}" alt="Order Image" class="w-full h-48 object-cover rounded-lg">
      </div>
      {% endif %}
    </div>

    <!-- Customer Information -->
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h3 class="text-xl font-semibold mb-4 text-gray-800">Customer Information</h3>
      
      <div class="space-y-4">
        <div class="flex justify-between">
          <span class="font-medium text-gray-600">Name:</span>
          <span class="text-gray-800">{{ order.owner_username }}</span>
        </div>
        
        {% if order.owner_phone %}
        <div class="flex justify-between">
          <span class="font-medium text-gray-600">Phone:</span>
          <a href="tel:{{ order.owner_phone }}" class="text-blue-600 hover:text-blue-800">
            {{ order.owner_phone }}
          </a>
        </div>
        {% endif %}
        
        {% if order.owner_email %}
        <div class="flex justify-between">
          <span class="font-medium text-gray-600">Email:</span>
          <a href="mailto:{{ order.owner_email }}" class="text-blue-600 hover:text-blue-800">
            {{ order.owner_email }}
          </a>
        </div>
        {% endif %}
        
        {% if order.owner_location %}
        <div class="flex justify-between">
          <span class="font-medium text-gray-600">Location:</span>
          <span class="text-gray-800">{{ order.owner_location }}</span>
        </div>
        {% endif %}
        
        {% if order.phone %}
        <div class="flex justify-between">
          <span class="font-medium text-gray-600">Order Phone:</span>
          <a href="tel:{{ order.phone }}" class="text-blue-600 hover:text-blue-800">
            {{ order.phone }}
          </a>
        </div>
        {% endif %}
        
        {% if order.call_time %}
        <div class="flex justify-between">
          <span class="font-medium text-gray-600">Best Time to Call:</span>
          <span class="text-gray-800">{{ order.call_time.title() }}</span>
        </div>
        {% endif %}
      </div>
      
      <!-- Contact Actions -->
      <div class="mt-6 space-y-2">
        {% if order.owner_phone %}
        <a href="tel:{{ order.owner_phone }}" 
           class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg text-center block transition-colors">
          üìû Call Customer
        </a>
        {% endif %}
        
        {% if order.owner_email %}
        <a href="mailto:{{ order.owner_email }}" 
           class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-center block transition-colors">
          ‚úâÔ∏è Email Customer
        </a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Accepted Providers Section -->
  {% if accepted_providers %}
  <div class="mt-8 bg-white p-6 rounded-xl shadow-lg">
    <h3 class="text-xl font-semibold mb-4 text-gray-800">Accepted Providers</h3>
    
    <div class="space-y-4">
      {% for provider in accepted_providers %}
      <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
        <div class="flex-1">
          <h4 class="font-medium text-gray-800">{{ provider.username }}</h4>
          <div class="text-sm text-gray-600 space-y-1">
            {% if provider.phone %}
            <p>üìû {{ provider.phone }}</p>
            {% endif %}
            {% if provider.email %}
            <p>‚úâÔ∏è {{ provider.email }}</p>
            {% endif %}
            {% if provider.location %}
            <p>üìç {{ provider.location }}</p>
            {% endif %}
            <p class="text-xs text-gray-500">Accepted: {{ provider.accepted_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
          </div>
        </div>
        
        {% if provider.username == order.approved_provider %}
        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
          ‚úÖ Approved
        </span>
        {% else %}
        <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium">
          ‚è≥ Pending
        </span>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Order Verification Status -->
  {% if order.is_verified %}
  <div class="mt-8 bg-green-50 border-l-4 border-green-500 p-6 rounded-xl shadow-lg">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-semibold text-green-800">‚úÖ Order Verified</h3>
      {% if order.verification_deadline %}
      <span id="countdown" class="text-sm font-medium text-green-700"></span>
      {% endif %}
    </div>
    {% if order.user_action %}
    <div class="mb-4">
      <p class="text-sm text-green-700">
        <strong>Your Action:</strong> <span class="uppercase">{{ order.user_action }}</span>
        {% if order.user_action_at %}
        <span class="text-xs text-green-600 ml-2">({{ order.user_action_at.strftime('%B %d, %Y at %I:%M %p') }})</span>
        {% endif %}
      </p>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Order Actions (Post-Verification) -->
  {% if session['username'] == order.owner_username and order.is_verified and not order.user_action %}
  <div class="mt-8 bg-white p-6 rounded-xl shadow-lg">
    <h3 class="text-xl font-semibold mb-4 text-gray-800">Action Required</h3>
    <p class="text-sm text-gray-600 mb-4">Please select an action for this verified order. You have 24 hours to respond, or the helper will receive a fine.</p>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <button onclick="handleUserAction({{ order.id }}, 'completed')" 
              class="bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg transition-colors font-medium">
        ‚úÖ Completed
      </button>
      <button onclick="handleUserAction({{ order.id }}, 'processing')" 
              class="bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg transition-colors font-medium">
        üîÑ Processing
      </button>
      <button onclick="handleUserAction({{ order.id }}, 'cancel')" 
              class="bg-red-600 hover:bg-red-700 text-white py-3 px-6 rounded-lg transition-colors font-medium">
        ‚ùå Cancel
      </button>
    </div>
  </div>
  {% elif session['username'] == order.owner_username and not order.is_verified %}
  <!-- Regular Order Actions (Pre-Verification) -->
  <div class="mt-8 bg-white p-6 rounded-xl shadow-lg">
    <h3 class="text-xl font-semibold mb-4 text-gray-800">Order Actions</h3>
    
    <div class="flex flex-wrap gap-4">
      {% if order.status == 'pending' %}
      <form action="{{ url_for('update_order_status', order_id=order.id) }}" method="post" class="inline">
        <input type="hidden" name="status" value="in_progress">
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors">
          Mark as In Progress
        </button>
      </form>
      {% elif order.status == 'in_progress' %}
      <form action="{{ url_for('update_order_status', order_id=order.id) }}" method="post" class="inline">
        <input type="hidden" name="status" value="completed">
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition-colors">
          Mark as Completed
        </button>
      </form>
      {% endif %}
      
      <a href="{{ url_for('cancel_order', order_id=order.id) }}" 
         class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg transition-colors"
         onclick="return confirm('Are you sure you want to cancel this order?')">
        Cancel Order
      </a>
    </div>
  </div>
  {% endif %}
</div>

<script>
  async function handleUserAction(orderId, action) {
    if (!confirm(`Are you sure you want to mark this order as ${action.toUpperCase()}?`)) {
      return;
    }
    
    try {
      const response = await fetch(`/user_action/${orderId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ action: action })
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert(data.message || `Order marked as ${action} successfully!`);
        window.location.reload();
      } else {
        alert(data.message || 'Failed to update order. Please try again.');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('An error occurred. Please try again.');
    }
  }
  
  // Countdown timer for verification deadline
  {% if order.verification_deadline and not order.user_action %}
  function updateCountdown() {
    const deadlineStr = '{{ order.verification_deadline.isoformat() if order.verification_deadline else "" }}';
    if (!deadlineStr) return;
    
    const deadline = new Date(deadlineStr);
    const now = new Date();
    const remaining = deadline - now;
    
    if (remaining <= 0) {
      const countdownEl = document.getElementById('countdown');
      if (countdownEl) countdownEl.textContent = 'Time Expired';
      return;
    }
    
    const hours = Math.floor(remaining / (1000 * 60 * 60));
    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
    
    const countdownEl = document.getElementById('countdown');
    if (countdownEl) {
      countdownEl.textContent = `${hours}h ${minutes}m ${seconds}s remaining`;
    }
  }
  
  updateCountdown();
  setInterval(updateCountdown, 1000);
  {% endif %}
</script>
{% endblock %}